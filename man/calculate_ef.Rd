% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/calculate_ef.R
\name{calculate_ef}
\alias{calculate_ef}
\title{Calculate Efficiency Factor (EF)}
\usage{
calculate_ef(
  activities_data,
  activity_type = c("Run", "Ride"),
  ef_metric = c("speed_hr", "gap_hr", "power_hr"),
  start_date = NULL,
  end_date = Sys.Date(),
  min_duration_mins = 20,
  min_steady_minutes = 20,
  steady_cv_threshold = 0.08,
  min_hr_coverage = 0.9,
  quality_control = c("off", "flag", "filter"),
  export_dir = NULL
)
}
\arguments{
\item{activities_data}{A data frame of activities from \code{load_local_activities()}.
Must contain columns: \code{date}, \code{type}, \code{moving_time}, \code{distance},
\code{average_heartrate}, and \code{average_watts} (for power_hr metric).}

\item{activity_type}{Character vector or single string specifying activity type(s)
to analyze. Common values: \code{"Run"}, \code{"Ride"}, or \code{c("Run", "Ride")}.
Default: \code{c("Run", "Ride")}.}

\item{ef_metric}{Character string specifying the efficiency metric:
\itemize{
\item \code{"speed_hr"}: Speed-based efficiency (for running).
Formula: speed (m/s) / avg_HR. Units: m/s/bpm (higher = better fitness)
\item \code{"gap_hr"}: Grade Adjusted Speed efficiency (for running on hilly terrain).
Formula: GAP speed (m/s) / avg_HR. Accounts for elevation changes. Units: m/s/bpm
\item \code{"power_hr"}: Power-based efficiency (for cycling).
Formula: avg_watts / avg_HR. Units: W/bpm (higher = better fitness)
Default: \code{c("speed_hr", "power_hr")} (uses first matching metric for activity type).
Note: \code{"pace_hr"} is accepted as a deprecated alias for \code{"speed_hr"} for
backward compatibility.
}}

\item{start_date}{Optional. Analysis start date (YYYY-MM-DD string, Date, or POSIXct).
Defaults to one year before \code{end_date}.}

\item{end_date}{Optional. Analysis end date (YYYY-MM-DD string, Date, or POSIXct).
Defaults to current date (Sys.Date()).}

\item{min_duration_mins}{Numeric. Minimum activity duration in minutes to include
in analysis (default: 20). Filters out very short activities that may not
represent steady-state aerobic efforts.}

\item{min_steady_minutes}{Numeric. Minimum duration (minutes) for steady-state segment (default: 20).
Activities shorter than this are automatically rejected for EF calculation.}

\item{steady_cv_threshold}{Numeric. Coefficient of variation threshold for steady-state (default: 0.08 = 8\%).
Activities with higher variability are rejected as non-steady-state.}

\item{min_hr_coverage}{Numeric. Minimum HR data coverage threshold (default: 0.9 = 90\%).
Activities with lower HR coverage are rejected as insufficient data quality.}

\item{quality_control}{Character. Quality control mode: "off" (no filtering), "flag" (mark issues),
or "filter" (exclude flagged data). Default "filter" for scientific rigor.}

\item{export_dir}{Optional. Path to Strava export directory containing activity files.
When provided, enables stream data analysis for more accurate steady-state detection.}
}
\value{
A tibble with the following columns:
\describe{
\item{date}{Activity date (Date class)}
\item{activity_type}{Activity type (character: "Run" or "Ride")}
\item{ef_value}{Efficiency Factor value (numeric). Higher = better fitness.
Units: m/s/bpm for speed_hr, W/bpm for power_hr.}
\item{status}{Character. "ok" for successful calculation with stream data, "no_streams" for
activity-level calculation without stream data, "non_steady" if steady-state
criteria not met, "insufficient_data" if data quality issues, "too_short" if below min_steady_minutes,
"insufficient_hr_data" if HR coverage below threshold.}
}
}
\description{
Efficiency Factor measures how much work you perform per unit of cardiovascular
effort. Higher EF indicates better aerobic fitness - you're able to maintain faster
pace or higher power at the same heart rate. Tracking EF over time helps monitor
aerobic base development and training effectiveness.

\strong{EF Metrics:}
\itemize{
\item \strong{speed_hr} (for running): Speed (m/s) / Average HR
\itemize{
\item Higher values = faster speed at same HR = better fitness
}
\item \strong{power_hr} (for cycling): Average Power (watts) / Average HR
\itemize{
\item Higher values = more power at same HR = better fitness
}
}

\strong{What Improves EF?}
\itemize{
\item Aerobic base building (Zone 2 training)
\item Improved running/cycling economy
\item Enhanced cardiovascular efficiency
\item Increased mitochondrial density
}
}
\details{
Computes Efficiency Factor (EF) for endurance activities, quantifying the
relationship between performance output (speed or power) and heart rate.
EF is a key indicator of aerobic fitness and training adaptation (Allen et al., 2019).

\strong{Algorithm:}
\enumerate{
\item Filter activities by type, date range, and minimum duration
\item For each activity, calculate:
\itemize{
\item speed_hr: (distance / moving_time) / average_heartrate
\item power_hr: average_watts / average_heartrate
}
\item Return one EF value per activity
}

\strong{Steady-State Detection Method:}

When stream data is available (via \code{export_dir}), the function applies a rolling
coefficient of variation (CV) approach to identify steady-state periods:
\enumerate{
\item \strong{Rolling window}: A sliding window (default 300 seconds, or 1/4 of data, min 60 s)
computes the rolling mean and standard deviation of the output metric (velocity or power).
\item \strong{CV calculation}: CV = rolling SD / rolling mean at each time point.
\item \strong{Threshold filtering}: Time points where CV < \code{steady_cv_threshold} (default 8\%)
are classified as steady-state.
\item \strong{Minimum duration}: At least \code{min_steady_minutes} of steady-state data
must be present; otherwise the activity is marked as \code{"non_steady"}.
\item \strong{EF computation}: The median EF across all steady-state data points is reported.
}

This approach follows the principle that valid EF comparisons require quasi-constant
output intensity, as outlined by Coyle & González-Alonso (2001), who demonstrated that
cardiovascular drift is meaningful only under steady-state exercise conditions.
The rolling CV method is a common signal-processing technique for detecting stationarity
in physiological time series.

\strong{Data Quality Considerations:}
\itemize{
\item Requires heart rate data (activities without HR are excluded)
\item power_hr requires power meter data (cycling with power)
\item Best for steady-state endurance efforts (tempo runs, long rides)
\item Interval workouts may give misleading EF values
\item Environmental factors (heat, altitude) can affect EF
}

\strong{Interpretation:}
\itemize{
\item \strong{Upward trend}: Improving aerobic fitness
\item \strong{Stable}: Maintenance phase
\item \strong{Downward trend}: Possible overtraining, fatigue, or environmental stress
\item \strong{Sudden drop}: Check for illness, equipment change, or data quality
}

\strong{Typical EF Ranges (speed_hr for running):}
\itemize{
\item Beginner: 0.01 - 0.015 (m/s per bpm)
\item Intermediate: 0.015 - 0.020
\item Advanced: 0.020 - 0.025
\item Elite: > 0.025
}

Note: EF values are relative to individual baseline. Focus on personal trends
rather than absolute comparisons with other athletes.
}
\examples{
# Example using simulated data
data(sample_ef)
print(head(sample_ef))

# Runnable example with dummy data:
end <- Sys.Date()
dates <- seq(end - 29, end, by = "day")
dummy_activities <- data.frame(
  date = dates,
  type = "Run",
  moving_time = rep(3600, length(dates)), # 1 hour
  distance = rep(10000, length(dates)),   # 10 km
  average_heartrate = rep(140, length(dates)),
  average_watts = rep(200, length(dates)),
  weighted_average_watts = rep(210, length(dates)),
  filename = "",
  stringsAsFactors = FALSE
)

# Calculate EF (Speed/HR)
ef_result <- calculate_ef(
  activities_data = dummy_activities,
  activity_type = "Run",
  ef_metric = "speed_hr",
  end_date = end
)
print(head(ef_result))

\dontrun{
# Example using local Strava export data
activities <- load_local_activities("strava_export_data/activities.csv")

# Calculate Speed/HR efficiency factor for Runs
ef_data_run <- calculate_ef(
  activities_data = activities,
  activity_type = "Run",
  ef_metric = "speed_hr"
)
print(tail(ef_data_run))

# Calculate Power/HR efficiency factor for Rides
ef_data_ride <- calculate_ef(
  activities_data = activities,
  activity_type = "Ride",
  ef_metric = "power_hr"
)
print(tail(ef_data_ride))
}
}
\references{
Allen, H., Coggan, A. R., & McGregor, S. (2019). \emph{Training and Racing with a
Power Meter} (3rd ed.). VeloPress.

Coyle, E. F., & González-Alonso, J. (2001). Cardiovascular drift during
prolonged exercise: New perspectives. \emph{Exercise and Sport Sciences Reviews},
29(2), 88-92. \doi{10.1097/00003677-200104000-00009}
}
\seealso{
\code{\link[=plot_ef]{plot_ef()}} for visualization with trend lines,
\code{\link[=calculate_decoupling]{calculate_decoupling()}} for within-activity efficiency analysis,
\code{\link[=load_local_activities]{load_local_activities()}} for data loading
}
