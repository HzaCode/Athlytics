% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/calculate_ef.R
\name{calculate_ef}
\alias{calculate_ef}
\title{Calculate Efficiency Factor (EF)}
\usage{
calculate_ef(
  activities_data,
  activity_type = c("Run", "Ride"),
  ef_metric = c("pace_hr", "power_hr", "Pace_HR", "Power_HR"),
  start_date = NULL,
  end_date = NULL,
  min_duration_mins = 20,
  min_steady_minutes = 20,
  steady_cv_threshold = 0.08,
  min_hr_coverage = 0.9,
  quality_control = c("off", "flag", "filter")
)
}
\arguments{
\item{activities_data}{A data frame of activities from \code{load_local_activities()}.
Must contain columns: \code{date}, \code{type}, \code{moving_time}, \code{distance},
\code{average_heartrate}, and \code{average_watts} (for Power_HR metric).}

\item{activity_type}{Character vector or single string specifying activity type(s)
to analyze. Common values: \code{"Run"}, \code{"Ride"}, or \code{c("Run", "Ride")}.
Default: \code{c("Run", "Ride")}.}

\item{ef_metric}{Character string specifying the efficiency metric:
\itemize{
\item \code{"pace_hr"} or \code{"Pace_HR"}: Pace-based efficiency (for running).
Formula: speed (m/s) / avg_HR. Units: m·s⁻¹·bpm⁻¹ (higher = better fitness)
\item \code{"power_hr"} or \code{"Power_HR"}: Power-based efficiency (for cycling).
Formula: avg_watts / avg_HR. Units: W·bpm⁻¹ (higher = better fitness)
}
Default: \code{c("pace_hr", "power_hr")} (uses first matching metric for activity type).
Note: Older capitalized names ("Pace_HR", "Power_HR") are supported for backward compatibility.}

\item{start_date}{Optional. Analysis start date (YYYY-MM-DD string, Date, or POSIXct).
Defaults to one year before \code{end_date}.}

\item{end_date}{Optional. Analysis end date (YYYY-MM-DD string, Date, or POSIXct).
Defaults to current date (Sys.Date()).}

\item{min_duration_mins}{Numeric. Minimum activity duration in minutes to include
in analysis (default: 20). Filters out very short activities that may not
represent steady-state aerobic efforts.}

\item{min_steady_minutes}{Numeric. Minimum duration (minutes) for steady-state segment (default: 20).
Activities shorter than this are automatically rejected for EF calculation.}

\item{steady_cv_threshold}{Numeric. Coefficient of variation threshold for steady-state (default: 0.08 = 8\%).
Activities with higher variability are rejected as non-steady-state.}

\item{min_hr_coverage}{Numeric. Minimum HR data coverage threshold (default: 0.9 = 90\%).
Activities with lower HR coverage are rejected as insufficient data quality.}

\item{quality_control}{Character. Quality control mode: "off" (no filtering), "flag" (mark issues),
or "filter" (exclude flagged data). Default "filter" for scientific rigor.}
}
\value{
A tibble with the following columns:
\describe{
\item{date}{Activity date (Date class)}
\item{activity_type}{Activity type (character: "Run" or "Ride")}
\item{ef_value}{Efficiency Factor value (numeric). Higher = better fitness.
Units: m·s⁻¹·bpm⁻¹ for pace_hr, W·bpm⁻¹ for power_hr.}
\item{status}{Character. "ok" for successful calculation, "non_steady" if steady-state
criteria not met, "insufficient_data" if data quality issues, "too_short" if below min_steady_minutes,
"insufficient_hr_data" if HR coverage below threshold.}
}
}
\description{
Efficiency Factor measures how much work you perform per unit of cardiovascular
effort. Higher EF indicates better aerobic fitness - you're able to maintain faster
pace or higher power at the same heart rate. Tracking EF over time helps monitor
aerobic base development and training effectiveness.

\strong{EF Metrics:}
\itemize{
\item \strong{Pace_HR} (for running): Speed (m/s) / Average HR
- Higher values = faster pace at same HR = better fitness
\item \strong{Power_HR} (for cycling): Average Power (watts) / Average HR
- Higher values = more power at same HR = better fitness
}

\strong{What Improves EF?}
\itemize{
\item Aerobic base building (Zone 2 training)
\item Improved running/cycling economy
\item Enhanced cardiovascular efficiency
\item Increased mitochondrial density
}
}
\details{
Computes Efficiency Factor (EF) for endurance activities, quantifying the
relationship between performance output (pace or power) and heart rate.
EF is a key indicator of aerobic fitness and training adaptation (Allen et al., 2019).

\strong{Algorithm:}
\enumerate{
\item Filter activities by type, date range, and minimum duration
\item For each activity, calculate:
\itemize{
\item Pace_HR: (distance / moving_time) / average_heartrate
\item Power_HR: average_watts / average_heartrate
}
\item Return one EF value per activity
}

\strong{Data Quality Considerations:}
\itemize{
\item Requires heart rate data (activities without HR are excluded)
\item Power_HR requires power meter data (cycling with power)
\item Best for steady-state endurance efforts (tempo runs, long rides)
\item Interval workouts may give misleading EF values
\item Environmental factors (heat, altitude) can affect EF
}

\strong{Interpretation:}
\itemize{
\item \strong{Upward trend}: Improving aerobic fitness
\item \strong{Stable}: Maintenance phase
\item \strong{Downward trend}: Possible overtraining, fatigue, or environmental stress
\item \strong{Sudden drop}: Check for illness, equipment change, or data quality
}

\strong{Typical EF Ranges (Pace_HR for running):}
\itemize{
\item Beginner: 0.01 - 0.015 (m/s per bpm)
\item Intermediate: 0.015 - 0.020
\item Advanced: 0.020 - 0.025
\item Elite: > 0.025
}

Note: EF values are relative to individual baseline. Focus on personal trends
rather than absolute comparisons with other athletes.
}
\examples{
# Example using simulated data
data(athlytics_sample_ef)
print(head(athlytics_sample_ef))

\dontrun{
# Example using local Strava export data
activities <- load_local_activities("strava_export_data/activities.csv")

# Calculate Pace/HR efficiency factor for Runs
ef_data_run <- calculate_ef(activities_data = activities, 
                             activity_type = "Run", 
                             ef_metric = "pace_hr")
print(tail(ef_data_run))

# Calculate Power/HR efficiency factor for Rides
ef_data_ride <- calculate_ef(activities_data = activities,
                              activity_type = "Ride",
                              ef_metric = "power_hr")
print(tail(ef_data_ride))
}
}
\references{
Allen, H., Coggan, A. R., & McGregor, S. (2019). \emph{Training and Racing with a
Power Meter} (3rd ed.). VeloPress.
}
\seealso{
\code{\link{plot_ef}} for visualization with trend lines,
\code{\link{calculate_decoupling}} for within-activity efficiency analysis,
\code{\link{load_local_activities}} for data loading
}
